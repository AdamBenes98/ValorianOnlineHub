<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VaOS - Valorian Operating System</title>
<style>
:root{--bg:#000;--card:#0a0a0a;--border:#222;--accent:#dc143c;--text:#fff;--sub:#aaa;--gap:1.2rem;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
a{color:var(--accent);text-decoration:none}

/* ---------- login / desktop / taskbar / windows ---------- */
.login-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:10000}
.login-container{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:2rem;width:90%;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
.login-container h2{text-align:center;margin-bottom:1.5rem;color:var(--accent);font-size:2rem}
.login-form input{width:100%;padding:.75rem;margin-bottom:1rem;border:1px solid var(--border);border-radius:6px;background:#111;color:var(--text);font-size:1rem}
.login-form button{width:100%;padding:.75rem;border:none;border-radius:6px;background:var(--accent);color:#fff;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s}
.login-form button:hover{background:#ff1744;transform:translateY(-2px)}
.error-message{color:var(--accent);text-align:center;margin-bottom:1rem;padding:.5rem;background:rgba(220,20,60,.1);border-radius:6px}
.desktop{position:fixed;inset:0;background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);display:none}
.desktop.active{display:block}
.taskbar{position:fixed;bottom:0;left:0;right:0;height:48px;background:var(--card);border-top:2px solid var(--accent);display:flex;align-items:center;justify-content:space-between;padding:0 1rem;z-index:1000}
.start-button{background:var(--accent);border:none;color:#fff;padding:.5rem 1rem;border-radius:6px;font-weight:bold;cursor:pointer}
.start-button:hover{background:#ff1744}
.taskbar-apps{display:flex;gap:.5rem;flex:1;margin:0 1rem}
.taskbar-app{background:rgba(255,255,255,.1);border:none;color:#fff;padding:.5rem .75rem;border-radius:6px;cursor:pointer;font-size:.9rem}
.taskbar-app:hover{background:rgba(255,255,255,.2)}
.taskbar-app.active{background:var(--accent)}
.system-tray{display:flex;align-items:center;gap:1rem;color:var(--sub);font-size:.9rem}
.start-menu{position:fixed;bottom:48px;left:1rem;width:300px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem;display:none;z-index:1001;box-shadow:0 10px 40px rgba(0,0,0,.5)}
.start-menu.active{display:block}
.start-menu-item{display:flex;align-items:center;gap:.75rem;padding:.75rem;border-radius:6px;cursor:pointer}
.start-menu-item:hover{background:rgba(255,255,255,.1)}
.desktop-icons{position:absolute;top:2rem;left:2rem;display:flex;flex-direction:column;gap:1.5rem}
.desktop-icon{display:flex;flex-direction:column;align-items:center;gap:.5rem;padding:1rem;border-radius:8px;cursor:pointer;background:rgba(255,255,255,.05);border:1px solid transparent;transition:.3s}
.desktop-icon:hover{background:rgba(255,255,255,.1);border-color:var(--accent);transform:translateY(-2px)}
.desktop-icon .emoji{font-size:2.5rem}
.window{position:absolute;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.5);min-width:400px;min-height:300px;display:flex;flex-direction:column;overflow:hidden}
.window-header{background:rgba(255,255,255,.05);padding:.75rem 1rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.window-title{display:flex;align-items:center;gap:.5rem;font-weight:500}
.window-controls{display:flex;gap:.5rem}
.window-control{width:12px;height:12px;border-radius:50%;cursor:pointer}
.window-control:hover{transform:scale(1.2)}
.window-control.close{background:#ff5f57}
.window-control.minimize{background:#ffbd2e}
.window-control.maximize{background:#28ca42}
.window-content{flex:1;padding:1.5rem;overflow:auto;background:var(--bg)}

/* ---------- apps ---------- */
.app-calculator{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;max-width:300px;margin:0 auto}
.calc-display{grid-column:1/-1;background:#111;padding:1rem;text-align:right;font-size:1.5rem;border-radius:6px;margin-bottom:.5rem;border:1px solid var(--border)}
.calc-btn{padding:1rem;border:none;background:#1a1a1a;color:var(--text);border-radius:6px;cursor:pointer;font-size:1.1rem;transition:.3s;border:1px solid var(--border)}
.calc-btn:hover{background:var(--accent);color:#fff}
.calc-btn.operator{background:var(--accent);color:#fff}
.app-text-editor{width:100%;height:300px;background:#111;color:var(--text);border:1px solid var(--border);border-radius:6px;padding:1rem;font-family:monospace;font-size:1rem;resize:vertical}
.app-terminal{background:#000;color:#0f0;font-family:monospace;padding:1rem;height:300px;overflow:auto;border-radius:6px}
.terminal-input{background:transparent;border:none;color:#0f0;outline:none;width:100%;font-family:monospace}
.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem}
.settings-item{background:#111;padding:1rem;border-radius:6px;border:1px solid var(--border)}
.settings-item label{display:block;margin-bottom:.5rem;color:var(--sub)}
.settings-item input,.settings-item select{width:100%;padding:.5rem;background:#000;color:var(--text);border:1px solid var(--border);border-radius:4px}
.hidden{display:none!important}
</style>
</head>
<body>

<!-- Login -->
<div id="login-screen" class="login-screen">
  <div class="login-container">
    <h2>VaOS Login</h2>
    <div id="error-message" class="error-message hidden"></div>
    <form id="login-form" class="login-form">
      <input type="text" id="login-username" placeholder="Username" required>
      <input type="password" id="login-password" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>
    <form id="register-form" class="login-form hidden">
      <input type="text" id="register-username" placeholder="Username" required>
      <input type="password" id="register-password" placeholder="Password" required>
      <input type="password" id="register-confirm" placeholder="Confirm Password" required>
      <button type="submit">Create Account</button>
    </form>
    <div class="login-toggle">
      <span id="form-toggle-text">Don't have an account?</span>
      <a id="form-toggle" onclick="toggleAuthForm()">Register here</a>
    </div>
  </div>
</div>

<!-- Desktop -->
<div id="desktop" class="desktop">
  <div class="desktop-icons">
    <div class="desktop-icon" onclick="openApp('calculator')"><div class="emoji">üßÆ</div><span>Calculator</span></div>
    <div class="desktop-icon" onclick="openApp('text-editor')"><div class="emoji">üìù</div><span>Text Editor</span></div>
    <div class="desktop-icon" onclick="openApp('terminal')"><div class="emoji">üíª</div><span>Terminal</span></div>
    <div class="desktop-icon" onclick="openApp('settings')"><div class="emoji">‚öôÔ∏è</div><span>Settings</span></div>
  </div>

  <div id="windows-container"></div>

  <div class="taskbar">
    <button class="start-button" onclick="toggleStartMenu()"><span>ü™ü VaOS</span></button>
    <div id="taskbar-apps" class="taskbar-apps"></div>
    <div class="system-tray">
      <span id="current-user"></span>
      <span id="system-time"></span>
      <button onclick="logout()" style="background:none;border:none;color:var(--accent);cursor:pointer;">Logout</button>
    </div>
  </div>

  <div id="start-menu" class="start-menu">
    <div class="start-menu-item" onclick="openApp('calculator')"><span>üßÆ</span><span>Calculator</span></div>
    <div class="start-menu-item" onclick="openApp('text-editor')"><span>üìù</span><span>Text Editor</span></div>
    <div class="start-menu-item" onclick="openApp('terminal')"><span>üíª</span><span>Terminal</span></div>
    <div class="start-menu-item" onclick="openApp('settings')"><span>‚öôÔ∏è</span><span>Settings</span></div>
  </div>
</div>

<script type="module">
import './vaos-firebase.js';

class VaOS {
  constructor() {
    this.currentUser = null;
    this.userData = null;
    this.windows = new Map();
    this.windowId = 0;
    this.init();
  }

  async init() {
    await window.vaosFirebase.init();
    this.setupEventListeners();
    this.updateClock();
    setInterval(() => this.updateClock(), 1000);
  }

  setupEventListeners() {
    document.getElementById('login-form').addEventListener('submit', async e => { e.preventDefault(); await this.login(); });
    document.getElementById('register-form').addEventListener('submit', async e => { e.preventDefault(); await this.register(); });
  }

  async login() {
    const u = document.getElementById('login-username').value;
    const p = document.getElementById('login-password').value;
    if (!u || !p) return this.showError('Enter username & password');
    const r = await window.vaosFirebase.login(u, p);
    if (!r.success) this.showError(r.error);
  }

  async register() {
    const u = document.getElementById('register-username').value;
    const p = document.getElementById('register-password').value;
    const c = document.getElementById('register-confirm').value;
    if (!u || !p) return this.showError('Fill all fields');
    if (!/^[a-zA-Z0-9_-]+$/.test(u)) return this.showError('Username: letters, numbers, -, _ only');
    if (p !== c) return this.showError('Passwords do not match');
    if (p.length < 6) return this.showError('Password ‚â• 6 chars');
    if (u.length < 3) return this.showError('Username ‚â• 3 chars');
    const r = await window.vaosFirebase.register(u, p);
    if (!r.success) this.showError(r.error);
  }

  logout() { window.vaosFirebase.logout(); }

  showLogin() {
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('desktop').classList.remove('active');
  }

  showDesktop() {
    this.currentUser = window.vaosFirebase.currentUser;
    this.userData = window.vaosFirebase.userData;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('desktop').classList.add('active');
    document.getElementById('current-user').textContent = this.userData?.username || 'User';
  }

  showError(msg) {
    const e = document.getElementById('error-message');
    e.textContent = msg; e.classList.remove('hidden');
    setTimeout(() => e.classList.add('hidden'), 5000);
  }

  updateClock() {
    document.getElementById('system-time').textContent = new Date().toLocaleTimeString();
  }

  toggleStartMenu() { document.getElementById('start-menu').classList.toggle('active'); }

  openApp(appName) {
    if (!this.checkAppPermission(appName)) { alert('Access denied.'); return; }
    const id = `win-${this.windowId++}`;
    const win = this.createWindow(id, appName);
    document.getElementById('windows-container').appendChild(win);
    this.windows.set(id, { element: win, app: appName });
    this.addToTaskbar(id, appName);
    this.makeWindowActive(id);
    document.getElementById('start-menu').classList.remove('active');
  }

  checkAppPermission(appName) {
    if (!this.userData) return false;
    if (this.userData.role === 'admin') return true;
    const field = { calculator: 'calculator', 'text-editor': 'textEditor', terminal: 'terminal', settings: 'settings' }[appName];
    return this.userData[field] === true;
  }

  createWindow(id, app) {
    const win = document.createElement('div');
    win.className = 'window'; win.id = id;
    win.style.top = '50px'; win.style.left = '50px'; win.style.width = '500px'; win.style.height = '400px';
    win.innerHTML = `
      <div class="window-header">
        <div class="window-title"><span>${this.getAppIcon(app)}</span><span>${this.getAppTitle(app)}</span></div>
        <div class="window-controls">
          <div class="window-control minimize" onclick="vaos.minimizeWindow('${id}')"></div>
          <div class="window-control maximize" onclick="vaos.maximizeWindow('${id}')"></div>
          <div class="window-control close" onclick="vaos.closeWindow('${id}')"></div>
        </div>
      </div>
      <div class="window-content">${this.createAppContent(app)}</div>`;
    this.makeWindowDraggable(win);
    return win;
  }

  createAppContent(app) {
    switch (app) {
      case 'calculator': return this.createCalculator();
      case 'text-editor': return this.createTextEditor();
      case 'terminal': return this.createTerminal();
      case 'settings': return this.createSettings();
      default: return '<div>App not found</div>';
    }
  }

  createCalculator() {
    const id = this.windowId;
    return `
      <div class="app-calculator">
        <div class="calc-display" id="calc-${id}">0</div>
        ${[7,8,9,'√∑',4,5,6,'√ó',1,2,3,'-',0,'.','=','+'].map(btn =>
          `<button class="calc-btn ${isNaN(btn)&&btn!=='.'?'operator':''}" onclick="vaos.calcPress('${btn}',${id})">${btn}</button>`).join('')}
      </div>`;
  }

  createTextEditor() {
    return `<textarea class="app-text-editor" id="txt-${this.windowId}" placeholder="Start typing...">${this.userData?.notes || ''}</textarea>`;
  }

  createTerminal() {
    const id = this.windowId;
    return `
      <div class="app-terminal">
        <div>VaOS Terminal v1.0 ‚Äì type 'help'</div>
        <div id="term-out-${id}"></div>
        <div style="display:flex"><span>${this.userData?.username}@vaos:~$ </span>
          <input type="text" class="terminal-input" id="term-in-${id}" onkeypress="vaos.terminalCommand(event,${id})">
        </div>
      </div>`;
  }

  createSettings() {
    return `
      <div class="settings-grid">
        <div class="settings-item">
          <label>Theme</label>
          <select onchange="vaos.updateSetting('theme',this.value)">
            <option value="dark" ${this.userData?.settings?.theme === 'dark' ? 'selected' : ''}>Dark</option>
            <option value="light" ${this.userData?.settings?.theme === 'light' ? 'selected' : ''}>Light</option>
          </select>
        </div>
        <div class="settings-item">
          <label>Animations</label>
          <select onchange="vaos.updateSetting('animations',this.value==='true')">
            <option value="true" ${this.userData?.settings?.animations ? 'selected' : ''}>Enabled</option>
            <option value="false" ${!this.userData?.settings?.animations ? 'selected' : ''}>Disabled</option>
          </select>
        </div>
        <div class="settings-item">
          <label>Notes</label>
          <button class="calc-btn" onclick="vaos.saveNotes()">Save Notes</button>
        </div>
      </div>`;
  }

  makeWindowDraggable(win) {
    const hdr = win.querySelector('.window-header');
    let dragging = false, startX, startY, initX, initY;
    hdr.addEventListener('mousedown', e => {
      if (e.target.closest('.window-controls')) return;
      dragging = true; startX = e.clientX; startY = e.clientY;
      initX = win.offsetLeft; initY = win.offsetTop;
    });
    document.addEventListener('mousemove', e => {
      if (!dragging) return;
      win.style.left = initX + e.clientX - startX + 'px';
      win.style.top = initY + e.clientY - startY + 'px';
    });
    document.addEventListener('mouseup', () => dragging = false);
  }

  addToTaskbar(id, app) {
    const btn = document.createElement('button'); btn.className = 'taskbar-app';
    btn.innerHTML = `${this.getAppIcon(app)} ${this.getAppTitle(app)}`;
    btn.onclick = () => this.toggleWindow(id);
    document.getElementById('taskbar-apps').appendChild(btn);
  }

  makeWindowActive(id) {
    document.querySelectorAll('.window').forEach(w => w.style.zIndex = '100');
    document.querySelectorAll('.taskbar-app').forEach(t => t.classList.remove('active'));
    const win = document.getElementById(id); if (win) win.style.zIndex = '101';
  }

  toggleWindow(id) {
    const w = document.getElementById(id);
    w.style.display = w.style.display === 'none' ? 'flex' : 'none';
    if (w.style.display === 'flex') this.makeWindowActive(id);
  }

  minimizeWindow(id) { document.getElementById(id).style.display = 'none'; }
  maximizeWindow(id) { document.getElementById(id).classList.toggle('maximized'); }

  closeWindow(id) {
    document.getElementById(id)?.remove();
    this.windows.delete(id);
    document.querySelectorAll('.taskbar-app').forEach((b, i) => {
      if ([...this.windows.keys()][i] === id) b.remove();
    });
  }

  getAppTitle(a) {
    return { calculator: 'Calculator', 'text-editor': 'Text Editor', terminal: 'Terminal', settings: 'Settings' }[a] || 'App';
  }
  getAppIcon(a) {
    return { calculator: 'üßÆ', 'text-editor': 'üìù', terminal: 'üíª', settings: '‚öôÔ∏è' }[a] || 'üìÑ';
  }

  calcPress(val, id) {
    const d = document.getElementById(`calc-${id}`);
    let cur = d.textContent;
    if (val === '=') { try { cur = eval(cur.replace(/√ó/g, '*').replace(/√∑/g, '/')); } catch { cur = 'Error'; } }
    else if (val === 'C') cur = '0';
    else cur = (cur === '0' || cur === 'Error') ? val : cur + val;
    d.textContent = cur;
  }

  terminalCommand(e, id) {
    if (e.key !== 'Enter') return;
    const input = e.target, cmd = input.value, out = document.getElementById(`term-out-${id}`);
    out.innerHTML += `<div>${this.userData?.username}@vaos:~$ ${cmd}</div>`;
    const resp = this.processTerminalCommand(cmd);
    if (resp) out.innerHTML += `<div>${resp}</div>`;
    input.value = ''; out.scrollTop = out.scrollHeight;
  }

  processTerminalCommand(cmd) {
    const [c, ...args] = cmd.split(' ');
    switch (c) {
      case 'help': return 'Commands: help clear date time echo whoami logout';
      case 'clear': return ''; case 'date': return new Date().toLocaleDateString();
      case 'time': return new Date().toLocaleTimeString();
      case 'echo': return args.join(' ');
      case 'whoami': return this.userData?.username || 'unknown';
      case 'logout': this.logout(); return 'Logging out‚Ä¶';
      default: return `Command not found: ${c}`;
    }
  }

  updateSetting(s, v) {
    if (!this.currentUser || !this.userData) return;
    this.userData.settings[s] = v;
  }

  async saveNotes() {
    if (!this.currentUser) return;
    const t = document.querySelector('.app-text-editor');
    if (t) this.userData.notes = t.value;
    const r = await window.vaosFirebase.saveUserData();
    alert(r.success ? 'Notes saved!' : 'Error: ' + r.error);
  }
}

window.toggleAuthForm = () => {
  const [l, r, t, a] = ['login-form', 'register-form', 'form-toggle-text', 'form-toggle'].map(id => document.getElementById(id));
  [l, r].forEach(f => f.classList.toggle('hidden'));
  if (l.classList.contains('hidden')) { t.textContent = 'Already have an account?'; a.textContent = 'Login here'; }
  else { t.textContent = "Don't have an account?"; a.textContent = 'Register here'; }
};
window.toggleStartMenu = () => document.getElementById('start-menu').classList.toggle('active');
window.openApp = a => window.vaos.openApp(a);
window.logout = () => window.vaos.logout();

window.vaos = new VaOS();

document.addEventListener('click', e => {
  if (!e.target.closest('#start-menu') && !e.target.closest('.start-button')) document.getElementById('start-menu').classList.remove('active');
});
</script>
</body>
</html>
