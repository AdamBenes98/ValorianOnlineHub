<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Role manager – Valoria</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#000;color:#fff;font-family:system-ui;padding:2rem}
table{width:100%;border-collapse:collapse;margin-top:1rem}
th,td{padding:.5rem;text-align:left;border-bottom:1px solid #333}
th{color:#dc143c}
input,select,button{padding:.4rem;border:none;border-radius:4px}
button{background:#dc143c;color:#fff;cursor:pointer}
.mono{font-family:monospace}
</style>
</head>
<body>
<h2>User Role Manager</h2>
<table id="tbl">
  <thead><tr><th>Email</th><th>UID</th><th>Roles</th><th>Action</th></tr></thead>
  <tbody></tbody>
</table>

<script type="module">
import { auth, db, role, collection, getDocs, onAuthStateChanged, signOut } from './firebase-config.js';

const tbody = document.querySelector('#tbl tbody');

/* ---- render table ---- */
async function load(){
  const snap = await getDocs(collection(db,"users"));
  tbody.innerHTML = "";
  snap.forEach(d=>{
    const data = d.data();
    const tr = document.createElement('tr');
    const emailCell = document.createElement('td');
    emailCell.textContent = data.email||'—';
    const uidCell = document.createElement('td');
    uidCell.textContent = d.id;
    uidCell.className = "mono";
    const roleCell = document.createElement('td');
    const sel = document.createElement('select');
    sel.multiple = true;
    ["admin","vai","voter","map","ivcf","gov"].forEach(r=>{
      const opt = document.createElement('option');
      opt.value = r; opt.textContent = r;
      if((data.roles||[]).includes(r)) opt.selected = true;
      sel.appendChild(opt);
    });
    roleCell.appendChild(sel);
    const actCell = document.createElement('td');
    const saveBtn = document.createElement('button');
    saveBtn.textContent = "Save";
    saveBtn.onclick = async ()=>{
      const chosen = Array.from(sel.selectedOptions).map(o=>o.value);
      await role.set(d.id, chosen);
      alert("Saved");
    };
    actCell.appendChild(saveBtn);
    tr.append(emailCell, uidCell, roleCell, actCell);
    tbody.appendChild(tr);
  });
}

/* ---- protect page ---- */
onAuthStateChanged(auth, async user=>{
  if(!user){ location = "index.html"; return; }
  const ok = await role.can(user, "admin");
  if(!ok){ alert("Admins only"); location = "index.html"; return; }
  load();
});
</script>
</body>
</html>
