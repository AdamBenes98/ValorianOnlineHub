<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>News Feed</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
/* ---------- THEME VARIABLES (exactly the ones you gave) ---------- */
:root{
  --bg:#000;
  --card:#0a0a0a;
  --border:#222;
  --accent:#dc143c;
  --text:#fff;
  --sub:#aaa;
  --gap:1.2rem;
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}
/* ---------- RESET & BASE ---------- */
*,*::before,*::after{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
a{color:var(--accent);text-decoration:none}
img,svg,video,iframe{max-width:100%;display:block}
input,button,textarea,select{font:inherit;color:inherit;background:transparent;border:1px solid var(--border);border-radius:4px;padding:.4rem .6rem}
button{cursor:pointer;background:var(--accent);color:#fff;border:none}
button:disabled{opacity:.45;cursor:not-allowed}
/* ---------- HEADER ---------- */
header{background:var(--card);border-bottom:2px solid var(--accent);padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between}
header h1{margin:0;font-size:1.6rem;letter-spacing:1px}
header span{font-weight:300;font-size:.9rem;color:var(--sub)}
header nav{display:flex;align-items:center;gap:1rem}
header nav button{background:none;border:1px solid var(--accent);color:var(--accent);padding:.4rem .7rem;border-radius:4px}
/* ---------- MAIN ---------- */
main{flex:1;padding:2rem;max-width:1100px;margin:auto;width:100%}
/* ---------- POST CARD ---------- */
.post{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:1rem;margin-bottom:1.2rem;position:relative;display:flex;flex-direction:column;gap:.5rem}
.post.pinned{border-color:var(--accent)}
.post-header{display:flex;align-items:center;gap:.6rem;font-size:.85rem;color:var(--sub)}
.post-header .name{font-weight:600;color:var(--text)}
.post-body{line-height:1.55;white-space:pre-wrap}
.post-body img,.post-body video{margin:.5rem 0;border-radius:6px}
.post-body .attachment audio{width:100%}
.post-footer{display:flex;align-items:center;gap:1rem;font-size:.8rem}
.post-footer .stats{margin-left:auto;display:flex;gap:.8rem;color:var(--sub)}
.post-actions{display:flex;gap:.8rem}
.post-actions button{background:none;border:none;color:var(--sub);display:flex;align-items:center;gap:.3rem;transition:color .15s}
.post-actions button:hover{color:var(--accent)}
.post-actions button.liked,.post-actions button.disliked{color:var(--accent)}
.post-options{margin-left:auto;position:relative}
.post-options>button{background:none;border:none;color:var(--sub);font-size:1.2rem}
.post-options .menu{position:absolute;top:100%;right:0;background:#111;border:1px solid var(--border);border-radius:6px;min-width:160px;z-index:10;display:none;flex-direction:column}
.post-options .menu.show{display:flex}
.post-options .menu button{background:none;border:none;text-align:left;padding:.6rem 1rem;font-size:.8rem;color:var(--text)}
.post-options .menu button:hover{background:#dc143c22}
/* ---------- COMMENTS ---------- */
.comments{margin-top:.8rem;padding-left:1rem;border-left:2px solid var(--border)}
.comment{background:#0003;padding:.6rem;border-radius:4px;margin-bottom:.6rem;font-size:.8rem}
.comment-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.3rem;color:var(--sub)}
.comment-body{line-height:1.4}
/* ---------- EDITOR ---------- */
.editor-toolbar{display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.4rem}
.editor-toolbar button,.editor-toolbar select{background:#111;border:1px solid var(--border);padding:.3rem .5rem;font-size:.8rem}
.new-post textarea{width:100%;min-height:120px;padding:.6rem;resize:vertical}
.new-post .counters{font-size:.7rem;color:var(--sub);display:flex;gap:.8rem;margin-top:.3rem}
.attachments{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
.attachments .thumb{position:relative;width:100px;height:100px;border-radius:6px;overflow:hidden;border:1px solid var(--border)}
.attachments .thumb img,.attachments .thumb video{width:100%;height:100%;object-fit:cover}
.attachments .thumb button{position:absolute;top:2px;right:2px;background:#0008;border:none;color:#fff;font-size:1rem;border-radius:50%;width:22px;height:22px;display:grid;place-items:center}
/* ---------- MODALS ---------- */
.modal{position:fixed;inset:0;background:#000c;display:none;align-items:center;justify-content:center;z-index:100}
.modal.show{display:flex}
.modal-content{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:1.5rem;max-width:500px;width:90%;max-height:90vh;overflow:auto;display:flex;flex-direction:gap:1rem}
.modal-header{display:flex;align-items:center;justify-content:space-between}
.modal-header h2{margin:0}
/* ---------- UTILS ---------- */
.hidden{display:none}
.muted{color:var(--sub)}
.mono{font-family:monospace}
badge{display:inline-block;background:var(--accent);color:#fff;padding:.15rem .35rem;border-radius:4px;font-size:.65rem;margin-left:.4rem}
/* ---------- DARK MODE TOGGLE ---------- */
#themeToggle{background:none;border:none;color:var(--accent);font-size:1.2rem}
/* ---------- RESPONSIVE ---------- */
@media(max-width:600px){
  header{flex-direction:column;align-items:flex-start;gap:.5rem}
  main{padding:1rem}
}
</style>
</head>
<body>
<!-- ---------- HEADER ---------- -->
<header>
  <div>
    <h1>News Feed</h1>
    <span>Official news &amp; updates</span>
  </div>
  <nav>
    <button id="backBtn" onclick="location.href='index.html'">‚Üê Main Page</button>
    <button id="themeToggle" title="Toggle dark/light">üåó</button>
  </nav>
</header>

<!-- ---------- MAIN ---------- -->
<main>
  <!-- Controls bar -->
  <section style="display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1.5rem;align-items:center">
    <input id="searchInput" placeholder="Search posts‚Ä¶" style="flex:1;min-width:220px">
    <select id="sortSelect">
      <option value="new">Newest first</option>
      <option value="old">Oldest first</option>
      <option value="likes">Most liked</option>
      <option value="comments">Most discussed</option>
    </select>
    <select id="filterSelect">
      <option value="all">All posts</option>
      <option value="media">Media only</option>
      <option value="text">Text only</option>
    </select>
    <button id="newPostBtn">‚úçÔ∏è New Post</button>
  </section>

  <!-- New post editor (hidden by default) -->
  <section id="editor" class="new-post hidden">
    <div class="editor-toolbar">
      <button data-cmd="bold" title="Bold"><b>B</b></button>
      <button data-cmd="italic" title="Italic"><i>I</i></button>
      <button data-cmd="underline" title="Underline"><u>U</u></button>
      <button data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
      <select data-cmd="fontSize" title="Font size">
        <option value="1">Small</option>
        <option value="3" selected>Normal</option>
        <option value="5">Large</option>
        <option value="7">X-Large</option>
      </select>
      <select data-cmd="fontName" title="Font family">
        <option value="system-ui">System</option>
        <option value="Arial">Arial</option>
        <option value="Georgia">Georgia</option>
        <option value="Times New Roman">Times</option>
        <option value="Courier New">Courier</option>
        <option value="Verdana">Verdana</option>
        <option value="Comic Sans MS">Comic</option>
        <option value="Impact">Impact</option>
      </select>
      <input type="color" data-cmd="foreColor" value="#ffffff" title="Text color">
      <input type="color" data-cmd="hiliteColor" value="#dc143c" title="Highlight">
      <button data-cmd="insertUnorderedList" title="Bullet list">‚Ä¢ List</button>
      <button data-cmd="insertOrderedList" title="Numbered list">1. List</button>
      <button data-cmd="removeFormat" title="Clear format">Clear</button>
      <button id="emojiBtn" title="Emoji">üòä</button>
    </div>
    <div contenteditable id="editorArea" style="background:#111;border:1px solid var(--border);border-radius:4px;padding:.6rem;min-height:120px;max-height:300px;overflow:auto"></div>
    <div class="counters">
      <span id="charCount">0</span> / 5 000 chars
      <span id="wordCount">0 words</span>
      <span id="readTime">0 min read</span>
    </div>
    <input type="file" id="attachFiles" accept="image/*,video/*,audio/*" multiple>
    <div id="attachPreview" class="attachments"></div>
    <div style="display:flex;gap:.5rem;margin-top:.5rem">
      <button id="publishBtn">Publish</button>
      <button id="cancelBtn">Cancel</button>
    </div>
  </section>

  <!-- Posts container -->
  <section id="feed"></section>
</main>

<!-- ---------- ADMIN LOGIN MODAL ---------- -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Admin Login</h2>
      <button onclick="closeModal('loginModal')">‚úï</button>
    </div>
    <label>Username
      <input id="loginUser" autocomplete="off">
    </label>
    <label>Password
      <input type="password" id="loginPass" autocomplete="off">
    </label>
    <button onclick="doLogin()">Login</button>
    <p id="loginErr" class="muted"></p>
  </div>
</div>

<!-- ---------- ADMIN TOOLS MODAL ---------- -->
<div id="adminModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Admin Tools</h2>
      <button onclick="closeModal('adminModal')">‚úï</button>
    </div>
    <div id="adminPanel"></div>
  </div>
</div>

<!-- ---------- EMOJI PALETTE ---------- -->
<div id="emojiModal" class="modal">
  <div class="modal-content" style="max-width:360px">
    <div class="modal-header">
      <h2>Pick an emoji</h2>
      <button onclick="closeModal('emojiModal')">‚úï</button>
    </div>
    <div id="emojiGrid" style="display:grid;grid-template-columns:repeat(9,1fr);gap:.3rem;font-size:1.4rem"></div>
  </div>
</div>

<!-- ---------- SCRIPTS ---------- -->
<script>
/* ========== CONFIG ========== */
const ADMIN_USER = 'master';
const ADMIN_PASS = 'M4sterP@ss';
const POST_LIMIT = 5000;
const SPAM_POST = 3000; // ms
const SPAM_COMMENT = 3000;

/* ========== STATE ========== */
let posts = JSON.parse(localStorage.getItem('newsPosts')||'[]');
let nextId = posts.length ? Math.max(...posts.map(p=>p.id)) + 1 : 1;
let deviceId = localStorage.getItem('deviceId') || crypto.randomUUID();
localStorage.setItem('deviceId', deviceId);
let adminToken = sessionStorage.getItem('adminToken') || null;
let editingId = null;
let lastPost = 0;
let lastComment = 0;

/* ========== THEME ========== */
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
if (!localStorage.theme) localStorage.theme = prefersDark ? 'dark' : 'light';
document.documentElement.setAttribute('data-theme', localStorage.theme);
themeToggle.textContent = localStorage.theme==='dark'?'üåô':'‚òÄÔ∏è';
themeToggle.onclick = ()=>{
  const t = localStorage.theme === 'dark' ? 'light' : 'dark';
  localStorage.theme = t;
  document.documentElement.setAttribute('data-theme', t);
  themeToggle.textContent = t==='dark'?'üåô':'‚òÄÔ∏è';
};

/* ========== UTILS ========== */
const qs = q=>document.querySelector(q);
const qsa = q=>[...document.querySelectorAll(q)];
const stamp = ()=>Date.now();
const uuid = ()=>crypto.randomUUID();
const escapeHTML = str=>str.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const formatTime = t=>{
  const s = (Date.now()-t)/1000;
  if (s<60) return 'now';
  const m = Math.floor(s/60);
  if (m<60) return m+' min ago';
  const h = Math.floor(m/60);
  if (h<24) return h+' h ago';
  const d = Math.floor(h/24);
  return d+' d ago';
};
const readingTime = txt=>{
  const w = txt.trim().split(/\s+/).length;
  return Math.ceil(w/200)||1;
};

/* ========== EMOJI ========== */
const EMOJIS = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üòà','üëø','üëπ','üë∫','ü§°','üí©','üëª','üíÄ','‚ò†Ô∏è','üëΩ','üëæ','ü§ñ','üéÉ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ','‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚òÆÔ∏è','‚úùÔ∏è','‚ò™Ô∏è','üïâÔ∏è','‚ò∏Ô∏è','‚ú°Ô∏è','üîØ','üïé','‚òØÔ∏è','‚ò¶Ô∏è','üõê','‚õé','‚ôà','‚ôâ','‚ôä','‚ôã','‚ôå','‚ôç','‚ôé','‚ôè','‚ôê','‚ôë','‚ôí','‚ôì','üÜî','‚öõÔ∏è','üâë','‚ò¢Ô∏è','‚ò£Ô∏è','üì¥','üì≥','üà∂','üàö','üà∏','üà∫','üà∑Ô∏è','‚ú¥Ô∏è','üÜö','üíÆ','üâê','„äôÔ∏è','„äóÔ∏è','üà¥','üàµ','üàπ','üà≤','üÖ∞Ô∏è','üÖ±Ô∏è','üÜé','üÜë','üÖæÔ∏è','üÜò','‚ùå','‚≠ï','üõë','‚õî','üìõ','üö´','üíØ','üí¢','‚ô®Ô∏è','üö∑','üöØ','üö≥','üö±','üîû','üìµ','üö≠','‚ùó','‚ùï','‚ùì','‚ùî','‚ÄºÔ∏è','‚ÅâÔ∏è','üîÖ','üîÜ','„ÄΩÔ∏è','‚ö†Ô∏è','üö∏','üî±','‚öúÔ∏è','üî∞','‚ôªÔ∏è','‚úÖ','üàØ','üíπ','‚ùáÔ∏è','‚ú≥Ô∏è','‚ùé','üåê','üí†','‚ìÇÔ∏è','üåÄ','üí§','üèß','üöæ','‚ôø','üÖøÔ∏è','üà≥','üàÇÔ∏è','üõÇ','üõÉ','üõÑ','üõÖ','üöπ','üö∫','üöº','üöª','üöÆ','üé¶','üì∂','üàÅ','üî£','‚ÑπÔ∏è','üî§','üî°','üî†','üÜñ','üÜó','üÜô','üÜí','üÜï','üÜì','0Ô∏è‚É£','1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','üîü','üî¢','#Ô∏è‚É£','*Ô∏è‚É£','‚èèÔ∏è','‚ñ∂Ô∏è','‚è∏Ô∏è','‚èØÔ∏è','‚èπÔ∏è','‚è∫Ô∏è','‚è≠Ô∏è','‚èÆÔ∏è','‚è©','‚è™','‚è´','‚è¨','‚óÄÔ∏è','üîº','üîΩ','‚û°Ô∏è','‚¨ÖÔ∏è','‚¨ÜÔ∏è','‚¨áÔ∏è','‚ÜóÔ∏è','‚ÜòÔ∏è','‚ÜôÔ∏è','‚ÜñÔ∏è','‚ÜïÔ∏è','‚ÜîÔ∏è','‚Ü™Ô∏è','‚Ü©Ô∏è','‚§¥Ô∏è','‚§µÔ∏è','üîÄ','üîÅ','üîÇ','üîÑ','üîÉ','üéµ','üé∂','‚ûï','‚ûñ','‚ûó','‚úñÔ∏è','‚ôæ','üí≤','üí±','‚Ñ¢Ô∏è','¬©Ô∏è','¬ÆÔ∏è','„Ä∞Ô∏è','‚û∞','‚ûø','üîö','üîô','üîõ','üîù','üîú','‚úîÔ∏è','‚òëÔ∏è','üîò','üî¥','üü†','üü°','üü¢','üîµ','üü£','‚ö´','‚ö™','üü§','üî∫','üîª','üî∏','üîπ','üî∂','üî∑','üî≥','üî≤','‚ñ™Ô∏è','‚ñ´Ô∏è','‚óæ','‚óΩ','‚óºÔ∏è','‚óªÔ∏è','üü•','üüß','üü®','üü©','üü¶','üü™','‚¨õ','‚¨ú','üü´','üîà','üîá','üîâ','üîä','üîî','üîï','üì£','üì¢','üëÅ‚Äçüó®','üí¨','üí≠','üóØÔ∏è','‚ô†Ô∏è','‚ô£Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','üÉè','üé¥','üÄÑ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö','üïõ','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶','üïß'];
EMOJIS.forEach(e=>{
  const b = document.createElement('button');
  b.textContent = e;
  b.onclick = ()=>{ document.execCommand('insertText',false,e); closeModal('emojiModal'); };
  emojiGrid.appendChild(b);
});
emojiBtn.onclick = ()=>showModal('emojiModal');

/* ========== EDITOR ========== */
editorArea.oninput = ()=>{
  const txt = editorArea.innerText;
  charCount.textContent = txt.length;
  wordCount.textContent = txt.trim().split(/\s+/).filter(Boolean).length;
  readTime.textContent = readingTime(txt);
};
editorToolbar.onclick = e=>{
  const cmd = e.target.dataset.cmd;
  if (!cmd) return;
  if (cmd==='hiliteColor') document.execCommand('backColor',false,e.target.value);
  else if (cmd==='foreColor') document.execCommand('foreColor',false,e.target.value);
  else if (cmd==='fontSize'||cmd==='fontName') document.execCommand(cmd,false,e.target.value);
  else document.execCommand(cmd,false,null);
  editorArea.focus();
};
attachFiles.onchange = e=>{
  [...e.target.files].forEach(file=>{
    if (file.size>5e6){ alert('Max 5 MB per file'); return; }
    const reader = new FileReader();
    reader.onload = ev=>{
      const url = ev.target.result;
      const wrap = document.createElement('div');
      wrap.className='thumb';
      if (file.type.startsWith('image/')){
        const img = new Image();
        img.src = url;
        wrap.appendChild(img);
      } else if (file.type.startsWith('video/')){
        const vid = document.createElement('video');
        vid.src = url; vid muted = true; vid.loop = true; vid.onclick = ()=>vid.play();
        wrap.appendChild(vid);
      } else if (file.type.startsWith('audio/')){
        const aud = document.createElement('audio');
        aud.src = url; aud.controls = true; aud.style.width='100%';
        wrap.appendChild(aud);
      }
      const del = document.createElement('button');
      del.innerHTML='‚úï'; del.onclick = ()=>wrap.remove();
      wrap.appendChild(del);
      attachPreview.appendChild(wrap);
    };
    reader.readAsDataURL(file);
  });
  e.target.value='';
};
publishBtn.onclick = ()=>{
  if (stamp()-lastPost<SPAM_POST){ alert('Please wait a few seconds before posting.'); return; }
  const body = editorArea.innerHTML.trim();
  if (!body){ alert('Write something‚Ä¶'); return; }
  if (body.length>POST_LIMIT){ alert('Too long'); return; }
  const attachments = [...attachPreview.querySelectorAll('img,video,audio')].map(el=>{
    const src = el.src;
    const type = el.tagName==='IMG'?'image':el.tagName==='VIDEO'?'video':'audio';
    return {type,src};
  });
  const name = prompt('Your name (optional):')||'Anonymous';
  const color = prompt('Name color (hex, optional):')||'';
  const post = {
    id: editingId||nextId++,
    title: '',
    body,
    author: {name,color},
    attachments,
    likes:new Set(),
    dislikes:new Set(),
    comments:[],
    pinned:false,
    locked:false,
    created: editingId ? posts.find(p=>p.id===editingId).created : stamp(),
    edited: editingId ? stamp() : null,
    views:0
  };
  if (editingId){
    const idx = posts.findIndex(p=>p.id===editingId);
    posts[idx] = {...posts[idx],...post};
    editingId = null;
  } else posts.unshift(post);
  save();
  render();
  cancelBtn.click();
  lastPost = stamp();
};
cancelBtn.onclick = ()=>{
  editorArea.innerHTML='';
  attachPreview.innerHTML='';
  editor.classList.add('hidden');
  newPostBtn.disabled = false;
  editingId = null;
};
newPostBtn.onclick = ()=>{
  editor.classList.remove('hidden');
  newPostBtn.disabled = true;
  editorArea.focus();
};

/* ========== RENDER ========== */
function render(){
  const s = searchInput.value.trim().toLowerCase();
  const sort = sortSelect.value;
  const filter = filterSelect.value;
  let list = posts.slice();
  if (s) list = list.filter(p=> (p.body+p.author.name).toLowerCase().includes(s));
  if (filter==='media') list = list.filter(p=>p.attachments.length);
  if (filter==='text') list = list.filter(p=>!p.attachments.length);
  if (sort==='old') list.reverse();
  if (sort==='likes') list.sort((a,b)=>b.likes.size - a.likes.size);
  if (sort==='comments') list.sort((a,b)=>b.comments.length - a.comments.length);
  list.sort((a,b)=> (b.pinned?1:0) - (a.pinned?1:0));
  feed.innerHTML = '';
  list.forEach(p=>feed.appendChild(createPostEl(p)));
}
function createPostEl(p){
  const div = document.createElement('div');
  div.className='post'+(p.pinned?' pinned':'');
  div.dataset.id = p.id;
  div.innerHTML = `
    <div class="post-header">
      <span class="name" ${p.author.color?`style="color:${p.author.color}"`:''}>${escapeHTML(p.author.name)}</span>
      <span class="muted">‚Ä¢ ${formatTime(p.created)}</span>
      ${p.pinned?'<span class="badge">Pinned</span>':''}
      ${p.locked?'<span class="badge">Locked</span>':''}
    </div>
    <div class="post-body">${p.body}</div>
    ${p.attachments.map(a=>{
      if (a.type==='image') return `<img src="${a.src}" loading="lazy">`;
      if (a.type==='video') return `<video src="${a.src}" controls muted loop></video>`;
      if (a.type==='audio') return `<div class="attachment"><audio src="${a.src}" controls></audio></div>`;
    }).join('')}
    <div class="post-footer">
      <div class="post-actions">
        <button class="like ${p.likes.has(deviceId)?'liked':''}" onclick="toggleLike(${p.id},'like')">üëç ${p.likes.size}</button>
        <button class="dislike ${p.dislikes.has(deviceId)?'disliked':''}" onclick="toggleLike(${p.id},'dislike')">üëé ${p.dislikes.size}</button>
        ${p.locked?'<span class="muted">Locked</span>':'<button onclick="showCommentBox('+p.id+')">üí¨ Reply</button>'}
      </div>
      <div class="stats muted">${readingTime(p.body)} min read ‚Ä¢ ${p.views} views</div>
      <div class="post-options">
        <button>‚ãØ</button>
        <div class="menu">
          <button onclick="sharePost(${p.id})">Share</button>
          <button onclick="copyText(${p.id})">Copy text</button>
          <button onclick="copyLink(${p.id})">Copy link</button>
          <button onclick="reportPost(${p.id})">Report</button>
          <button onclick="showAdmin(${p.id})">Admin features</button>
        </div>
      </div>
    </div>
    <div id="comments-${p.id}" class="comments"></div>
  `;
  // render comments
  const cdiv = div.querySelector(`#comments-${p.id}`);
  p.comments.forEach(c=>{
    const cd = document.createElement('div');
    cd.className='comment';
    cd.innerHTML = `
      <div class="comment-header">
        <span class="name" ${c.author.color?`style="color:${c.author.color}"`:''}>${escapeHTML(c.author.name)}</span>
        <span class="muted">‚Ä¢ ${formatTime(c.created)}</span>
      </div>
      <div class="comment-body">${c.body}</div>
    `;
    cdiv.appendChild(cd);
  });
  // inc view
  if (!p.views) p.views=0;
  if (!p.lastView||stamp()-p.lastView>60_000){
    p.views++;
    p.lastView = stamp();
    save();
  }
  return div;
}
/* ========== POST ACTIONS ========== */
function toggleLike(pid,type){
  const p = posts.find(x=>x.id===pid);
  if (!p) return;
  const set = type==='like'?p.likes:p.dislikes;
  const other = type==='like'?p.dislikes:p.likes;
  if (set.has(deviceId)) set.delete(deviceId);
  else { set.add(deviceId); other.delete(deviceId); }
  save(); render();
}
function showCommentBox(pid){
  const p = posts.find(x=>x.id===pid);
  if (p.locked) return;
  const box = qs(`#comments-${pid}`);
  if (box.querySelector('.comment-box')) return;
  const cbox = document.createElement('div');
  cbox.className='comment-box';
  cbox.innerHTML = `<input placeholder="Write a reply‚Ä¶"><button>Post</button>`;
  const inp = cbox.querySelector('input');
  const btn = cbox.querySelector('button');
  btn.onclick = ()=>{
    if (stamp()-lastComment<SPAM_COMMENT){ alert('Wait a bit‚Ä¶'); return; }
    const v = inp.value.trim();
    if (!v) return;
    const name = prompt('Your name (optional):')||'Anonymous';
    const color = prompt('Name color (hex, optional):')||'';
    p.comments.push({
      id: uuid(),
      body: escapeHTML(v),
      author:{name,color},
      created: stamp()
    });
    save(); render();
    lastComment = stamp();
  };
  box.appendChild(cbox);
  inp.focus();
}
function sharePost(pid){
  const p = posts.find(x=>x.id===pid);
  const url = location.href.split('#')[0]+'#post-'+pid;
  const text = `Check this: ${p.body.slice(0,100)}‚Ä¶`;
  if (navigator.share) navigator.share({title:'News post',text,url});
  else alert('Share:\n'+url);
}
function copyText(pid){
  const p = posts.find(x=>x.id===pid);
  navigator.clipboard.writeText(p.body);
  alert('Text copied');
}
function copyLink(pid){
  const url = location.href.split('#')[0]+'#post-'+pid;
  navigator.clipboard.writeText(url);
  alert('Link copied');
}
function reportPost(pid){ alert('Reported ‚Äì admins will review.'); }

/* ========== ADMIN ========== */
function showAdmin(pid){
  showModal('loginModal');
  loginModal.dataset.pid = pid;
}
function doLogin(){
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();
  if (u===ADMIN_USER && p===ADMIN_PASS){
    adminToken = uuid();
    sessionStorage.setItem('adminToken', adminToken);
    closeModal('loginModal');
    showAdminTools(+loginModal.dataset.pid);
  } else {
    loginErr.textContent = 'Wrong credentials';
  }
}
function showAdminTools(pid){
  const p = posts.find(x=>x.id===pid);
  if (!p) return;
  showModal('adminModal');
  adminPanel.innerHTML = `
    <p><b>Post #${p.id}</b></p>
    <button onclick="pinPost(${pid})">${p.pinned?'Unpin':'Pin'} post</button>
    <button onclick="lockPost(${pid})">${p.locked?'Unlock':'Lock'} post</button>
    <button onclick="editPost(${pid})">Edit post</button>
    <button onclick="deletePost(${pid})">Delete post</button>
    <hr>
    <button onclick="exportJSON()">Export all posts (JSON)</button>
    <input type="file" id="importFile" accept=".json" onchange="importJSON(event)">
    <button onclick="document.getElementById('importFile').click()">Import JSON</button>
  `;
}
function pinPost(pid){
  const p = posts.find(x=>x.id===pid);
  p.pinned = !p.pinned;
  save(); render(); closeModal('adminModal');
}
function lockPost(pid){
  const p = posts.find(x=>x.id===pid);
  p.locked = !p.locked;
  save(); render(); closeModal('adminModal');
}
function editPost(pid){
  const p = posts.find(x=>x.id===pid);
  editingId = pid;
  editorArea.innerHTML = p.body;
  attachPreview.innerHTML = p.attachments.map(a=>{
    if (a.type==='image') return `<div class="thumb"><img src="${a.src}"><button onclick="this.parentElement.remove()">‚úï</button></div>`;
    if (a.type==='video') return `<div class="thumb"><video src="${a.src}"></video><button onclick="this.parentElement.remove()">‚úï</button></div>`;
    if (a.type==='audio') return `<div class="thumb"><audio src="${a.src}" controls></audio><button onclick="this.parentElement.remove()">‚úï</button></div>`;
  }).join('');
  editor.classList.remove('hidden');
  newPostBtn.disabled = true;
  closeModal('adminModal');
}
function deletePost(pid){
  if (!confirm('Delete forever?')) return;
  posts = posts.filter(p=>p.id!==pid);
  save(); render(); closeModal('adminModal');
}
function exportJSON(){
  const data = JSON.stringify(posts,null,2);
  const blob = new Blob([data],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'news-backup.json'; a.click();
  URL.revokeObjectURL(url);
}
function importJSON(e){
  const file = e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = ()=>{
    try {
      const arr = JSON.parse(r.result);
      if (!Array.isArray(arr)) throw 0;
      posts = arr;
      nextId = posts.length ? Math.max(...posts.map(p=>p.id)) + 1 : 1;
      save(); render();
      alert('Imported');
    } catch {
      alert('Invalid file');
    }
  };
  r.readAsText(file);
}

/* ========== MODALS ========== */
function showModal(id){ qs('#'+id).classList.add('show'); }
function closeModal(id){ qs('#'+id).classList.remove('show'); }

/* ========== SEARCH / SORT / FILTER ========== */
searchInput.oninput = ()=>render();
sortSelect.onchange = ()=>render();
filterSelect.onchange = ()=>render();

/* ========== SAVE / LOAD ========== */
function save(){
  // convert Sets to Arrays for JSON
  const data = posts.map(p=>({...p, likes:[...p.likes], dislikes:[...p.dislikes]}));
  localStorage.setItem('newsPosts', JSON.stringify(data));
}
/* migrate old format */
posts.forEach(p=>{
  if (!p.likes) p.likes = [];
  if (!p.dislikes) p.dislikes = [];
  p.likes = new Set(p.likes);
  p.dislikes = new Set(p.dislikes);
  if (!p.attachments) p.attachments = [];
  if (!p.comments) p.comments = [];
  if (!p.views) p.views = 0;
});

/* ========== INIT ========== */
render();
setInterval(render, 60_000); // update timestamps
window.onkeydown = e=>{
  if (e.key==='Escape') qsa('.modal').forEach(m=>m.classList.remove('show'));
  if (e.key==='/' && e.ctrlKey===false && document.activeElement!==searchInput){ searchInput.focus(); e.preventDefault(); }
};
</script>
</body>
</html>
