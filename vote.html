<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Parliament – Live Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="hub.css">
<style>
body{background:var(--bg);color:var(--text);padding:2rem;max-width:600px;margin:auto}
input,button{padding:.5rem;border:none;border-radius:4px}
input{background:#222;color:var(--text);width:100%;margin-bottom:.5rem}
button{background:var(--accent);color:#fff;cursor:pointer;font-weight:bold}
#barWrap{background:#222;border-radius:4px;height:28px;margin-top:1rem;overflow:hidden}
#barYes{height:100%;background:var(--accent);width:0%;transition:width .3s}
.small{color:var(--sub);font-size:.75rem}
</style>
</head>
<body>
<div class="small"><a href="hub.html">← Back to Hub</a></div>
<h1>Parliament – Live Vote</h1>

<!-- KEY GATE -->
<section id="gateSec">
  <input id="keyIn" type="password" placeholder="Enter voting key">
  <button onclick="unlock()">Unlock</button>
</section>

<!-- BALLOT -->
<section id="voteSec" style="display:none">
  <h2 id="qTitle"></h2>
  <p id="deadline" class="small"></p>
  <button id="yesBtn" onclick="submitVote(true)"></button>
  <button id="noBtn"  onclick="submitVote(false)"></button>
  <div id="barWrap"><div id="barYes"></div></div>
  <p class="small">
    <span id="yes">0</span> <span id="yesL">Yes</span> (<span id="yesP">0</span>%) ·
    <span id="no">0</span> <span id="noL">No</span>  (<span id="noP">0</span>%)
  </p>
</section>

<script>
/* ============================================================
   GOVERNMENT EDITORS ONLY → ADD / REMOVE KEYS HERE
   base64-encode each key  (btoa('MyKey123'))
============================================================ */
const KEY_B64 = [
  'TXlLZXkxMjM=',   // MyKey123
  'YWxpY2VLZXk=',   // aliceKey
  'Ym9iU2VjcmV0'    // bobSecret
];
/* ========================================================== */

const POLL_KEY   = 'currentPoll';
const VOTE_KEY   = 'votes';
const TOKEN_KEY  = 'voteToken';   // stores the key that logged in

function $(s){return document.querySelector(s)}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function load(k,def=null){try{return JSON.parse(localStorage.getItem(k))}catch{return def}}

// decode key list
const KEYS = KEY_B64.map(b=>atob(b));

/* -------- poll load / expire -------- */
let poll = load(POLL_KEY, {
  title:'Should we adopt the new flag design?',
  labelYes:'Yes',
  labelNo:'No',
  end: new Date(Date.now() + 24*3600*1000).toISOString()
});
if (new Date(poll.end) < new Date()){
  localStorage.removeItem(POLL_KEY);
  localStorage.removeItem(VOTE_KEY);
  location.replace('archive.html');
}
$('h2#qTitle').textContent = poll.title;
$('button#yesBtn').textContent = poll.labelYes;
$('button#noBtn').textContent  = poll.labelNo;

/* -------- key gate -------- */
window.unlock = function(){
  const k = $('input#keyIn').value.trim();
  if (!KEYS.includes(k)) return alert('Invalid key');
  if (load(VOTE_KEY,{})[k]) return alert('This key has already voted!');
  // store the key as "logged-in" token
  localStorage.setItem(TOKEN_KEY, k);
  $('section#gateSec').style.display='none';
  $('section#voteSec').style.display='block';
  showCount();
};
// auto-login if key present and not voted
const tok = localStorage.getItem(TOKEN_KEY);
if (tok && KEYS.includes(tok) && !load(VOTE_KEY,{})[tok]){
  $('section#gateSec').style.display='none';
  $('section#voteSec').style.display='block';
  showCount();
}

/* -------- vote once -------- */
window.submitVote = function(yes){
  const votes = load(VOTE_KEY,{});
  const key   = localStorage.getItem(TOKEN_KEY);
  if (!key || !KEYS.includes(key)) return;
  if (votes[key]) return alert('Key already used!');
  votes[key] = yes;
  save(VOTE_KEY, votes);
  localStorage.removeItem(TOKEN_KEY);   // burn token
  alert('Vote recorded!');
  showCount();
};

/* -------- live bar -------- */
function showCount(){
  const votes = load(VOTE_KEY,{});
  const yes = Object.values(votes).filter(v=>v===true).length;
  const no  = Object.values(votes).filter(v=>v===false).length;
  const tot = (yes+no)||1;
  $('span#yes').textContent=yes; $('span#no').textContent=no;
  $('span#yesP').textContent=(100*yes/tot).toFixed(1);
  $('span#noP').textContent=(100*no/tot).toFixed(1);
  $('div#barYes').style.width=(100*yes/tot)+'%';
}
showCount();

/* -------- countdown -------- */
setInterval(()=>{
  const left=new Date(poll.end)-new Date();
  if(left<=0){location.replace('archive.html')}
  const h=String(Math.floor(left/36e5)).padStart(2,0);
  const m=String(Math.floor(left/6e4)%60).padStart(2,0);
  const s=String(Math.floor(left/1e3)%60).padStart(2,0);
  $('p#deadline').textContent=`Closes in ${h}:${m}:${s}`;
},1000);
</script>
</body>
</html>
