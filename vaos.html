<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>VaOS ‚Äì Valorian Online Hub</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

  <style>
    :root{
      --accent:#dc143c;
      --bg:#0d0d0d;
      --card:#1a1a1a;
      --text:#e6e6e6;
      --radius:8px;
      --font:"Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:var(--font);}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100vh;}
    header{background:#111;padding:.6rem 1rem;display:flex;align-items:center;justify-content:space-between;}
    header h1{font-size:1.2rem;color:var(--accent);}
    #loginPage,#desktop{display:flex;flex:1;align-items:center;justify-content:center;}
    .card{background:var(--card);padding:1.5rem 2rem;border-radius:var(--radius);width:320px;}
    input{width:100%;padding:.6rem;margin:.4rem 0;border:none;border-radius:var(--radius);}
    button{width:100%;padding:.6rem;margin-top:.6rem;border:none;border-radius:var(--radius);background:var(--accent);color:#fff;font-weight:bold;cursor:pointer;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    #desktop{flex-direction:column;display:none;}
    #appGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:1rem;width:90%;max-width:900px;margin:2rem 0;}
    .appTile{background:var(--card);padding:1rem;border-radius:var(--radius);text-align:center;cursor:pointer;transition:transform .15s;}
    .appTile:hover{transform:scale(1.05);}
    footer{text-align:center;padding:.6rem;font-size:.75rem;color:#666;}
    #adminPanel{display:none;background:#111;margin:1rem 0;padding:1rem;border-radius:var(--radius);width:90%;max-width:900px;}
    table{width:100%;border-collapse:collapse;margin-top:.5rem;}
    th,td{padding:.4rem .6rem;text-align:left;}
    tr:nth-child(even){background:#1a1a1a;}
    small{color:#aaa;}
  </style>
</head>
<body>
<header>
  <h1>VaOS</h1>
  <div id="userInfo"></div>
</header>

<!-- ========= LOGIN PAGE ========= -->
<section id="loginPage">
  <div class="card">
    <h2 style="margin-bottom:1rem;text-align:center;color:var(--accent)">VaOS Login</h2>
    <input id="userIn" placeholder="Username"/>
    <input id="passIn" type="password" placeholder="Password"/>
    <button id="logBtn">Log In</button>
    <button id="regBtn">Create Account</button>
    <p id="logInfo" style="color:var(--accent);margin-top:.5rem;text-align:center"></p>
  </div>
</section>

<!-- ========= DESKTOP ========= -->
<section id="desktop">
  <div id="appGrid">
    <div class="appTile" data-app="news"><h3>üì∞</h3><p>News Feed</p></div>
    <div class="appTile" data-app="vault"><h3>üóÉÔ∏è</h3><p>Vault</p></div>
    <div class="appTile" data-app="settings"><h3>‚öôÔ∏è</h3><p>Settings</p></div>
  </div>

  <!-- Admin panel (only AdamekBns) -->
  <div id="adminPanel">
    <h3>Admin Panel</h3>
    <button id="toggleFeature">Toggle Feature X globally</button>
    <table id="userTable">
      <thead><tr><th>Username</th><th>UID</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<footer>VaOS &copy; 2025 Valorian Online Hub</footer>

<script>
/* ===============  CONFIG  =============== */
const firebaseConfig = {
  apiKey: "AIzaSyBJT4Bh-Q0gTefjdYN-_3NMdrwo8pDN_ww",
  authDomain: "valorian-online-hub.firebaseapp.com",
  projectId: "valorian-online-hub",
  storageBucket: "valorian-online-hub.firebasestorage.app",
  messagingSenderId: "470140523501",
  appId: "1:470140523501:web:45a37c6aed375709660de4",
  measurementId: "G-XSYXNN56HR"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
firebase.analytics();

/* ===============  AUTH  =============== */
const loginPage  = document.getElementById('loginPage');
const desktop    = document.getElementById('desktop');
const userInfo   = document.getElementById('userInfo');
const logInfo    = document.getElementById('logInfo');

document.getElementById('logBtn').onclick = () => authenticate('in');
document.getElementById('regBtn').onclick = () => authenticate('up');

/* persist session */
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

function authenticate(mode){
  const user = userIn.value.trim();
  const pass = passIn.value.trim();
  if(!user || !pass) return flash("Enter both fields");
  const task = mode==='up'
    ? auth.createUserWithEmailAndPassword(user+'@vaos.local', pass)
    : auth.signInWithEmailAndPassword(user+'@vaos.local', pass);
  task.catch(e=>flash(e.code));
}
function flash(msg){ logInfo.textContent=msg; setTimeout(()=>logInfo.textContent='',2500); }

/* ===============  ROUTING  =============== */
let ME; // current user doc
auth.onAuthStateChanged(async u=>{
  if(!u){ loginPage.style.display='flex'; desktop.style.display='none'; return; }
  loginPage.style.display='none';
  desktop.style.display='flex';
  userInfo.textContent = `Hi, ${u.email.split('@')[0]}`;
  ME = await ensureUserDoc(u);
  if(u.email.split('@')[0]==='AdamekBns') enableAdmin();
  loadUserApps();
});

/* ===============  USER DOC  =============== */
async function ensureUserDoc(u){
  const ref = db.collection('users').doc(u.uid);
  const snap = await ref.get();
  if(!snap.exists){
    await ref.set({
      username: u.email.split('@')[0],
      created: firebase.firestore.FieldValue.serverTimestamp(),
      settings:{theme:'dark'},
      features:{news:true,vault:true}
    });
  }
  return (await ref.get()).data();
}

/* ===============  ADMIN ONLY  =============== */
async function enableAdmin(){
  adminPanel.style.display='block';
  renderUsers();
  document.getElementById('toggleFeature').onclick = async ()=>{
    const ref = db.collection('meta').doc('features');
    const snap = await ref.get();
    const curr = snap.exists ? snap.data().globalX : true;
    await ref.set({globalX:!curr},{merge:true});
    alert('Feature X is now '+!curr);
  };
}
async function renderUsers(){
  const snap = await db.collection('users').get();
  const tbody = userTable.querySelector('tbody');
  tbody.innerHTML='';
  snap.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${d.data().username}</td>
      <td>${d.id}</td>
      <td><button onclick="deleteUser('${d.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}
window.deleteUser = async uid=>{
  if(!confirm('Delete this user?')) return;
  await db.collection('users').doc(uid).delete();
  renderUsers();
}

/* ===============  APPS  =============== */
function loadUserApps(){
  document.querySelectorAll('.appTile').forEach(tile=>{
    const app = tile.dataset.app;
    tile.onclick = () => openApp(app);
  });
}
function openApp(app){
  alert(`Opening ${app} (placeholder ‚Äì wire your own iframe or route here)`);
}
</script>
</body>
</html>
