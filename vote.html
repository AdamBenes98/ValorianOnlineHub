<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Parliament ‚Äì Live Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó≥Ô∏è</text></svg>">
<style>
:root{
  --bg:#111;
  --text:#ffffff;
  --sub:#999;
  --blue:#00b4ff;
  --green:#00c853;
  --red:#ff5252;
  --radius:4px;
  --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
@media (prefers-color-scheme:light){
  :root{ --bg:#1e1e1e; --card:#1e1e1e; --text:#ffffff; --sub:#aaa; }
}
.ivcf-page{background:var(--bg);color:var(--text);display:none}
.ivcf-page.active{display:block}
.ivcf-header{background:#1e1e1e;border-bottom:2px solid var(--red);padding:1rem 2rem;display:flex;align-items:center;gap:1.5rem}
.ivcf-header h1{margin:0;font-size:1.6rem;color:var(--text)}
.ivcf-nav{display:flex;gap:1rem;flex-wrap:wrap}
.ivcf-nav a{padding:.4rem .7rem;border-radius:var(--radius);background:#0003;text-decoration:none;color:var(--text)}
.ivcf-nav a.active{background:var(--red);color:#000;font-weight:bold}
.ivcf-main{padding:2rem;max-width:1200px;margin:auto}
.ivcf-section{display:none}
.ivcf-section.active{display:block}
.ivcf-table{width:100%;border-collapse:collapse;margin-top:1rem}
.ivcf-table th,.ivcf-table td{padding:.5rem;text-align:left;border-bottom:1px solid #333}
.ivcf-table th{color:var(--blue)}
.ivcf-card{background:#1e1e1e;padding:1.2rem;border-radius:8px;margin-bottom:1.2rem;color:var(--text)}
.ivcf-input,.ivcf-select,.ivcf-button{padding:.5rem;border:none;border-radius:var(--radius);font-family:var(--font);font-size:1rem}
.ivcf-input,.ivcf-select{background:#222;color:var(--text);width:100%}
.ivcf-button{background:var(--red);color:#000;cursor:pointer;font-weight:bold;transition:filter .15s}
.ivcf-button:hover{filter:brightness(1.15)}
.ivcf-button:active{filter:brightness(0.85)}
#barWrap{height:28px;background:var(--red);border-radius:var(--radius);overflow:hidden;margin:1rem 0}
#barYes{height:100%;background:var(--green);width:0%;transition:width .4s}
body{margin:0;background:var(--bg);font-family:var(--font);display:flex;align-items:center;justify-content:center;min-height:100vh}
a{color:var(--red)}
.small{font-size:.8rem;color:var(--sub)}
#qrBox{display:none}
</style>
</head>
<body>
<div id="app"></div>

<script type="module">
/* ----------  FIREBASE  ---------- */
import { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
         doc, setDoc, getDoc, updateDoc, collection, query, where, onSnapshot, getDocs, deleteField } 
from './firebase-config.js';
import { ..., deleteDoc, collection, getDocs,
+        deleteField } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  export { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
         doc, setDoc, getDoc, updateDoc, deleteDoc, collection, getDocs,
+        deleteField };
/* ----------  CONSTANTS  ---------- */
const ADMIN_EMAIL = 'adamekbns@valorian.eu';   // master account e-mail
let   currentUser = null;                     // firebase user object
let   unsubPoll   = null;                     // live listener

/* ----------  HELPERS  ---------- */
const $ = q => document.querySelector(q);
const today = () => new Date().toISOString().slice(0,10);

/* ----------  ROUTING  ---------- */
function start(){
  onAuthStateChanged(auth, user => {
    currentUser = user;
    if (!user) { renderGate(); return; }
    if (user.email === ADMIN_EMAIL) { renderAdminPanel(); return; }
    checkVoterAndLoad(user.email);
  });
}
start();

/* ==========================================
   GENERAL PAGES
   ========================================== */
window.renderGate = () => {
  app.innerHTML = `
  <div class="ivcf-card">
    <h1>Parliament ‚Äì Live Vote</h1>
    <p class="small">Choose your role:</p>
    <button class="ivcf-button" onclick="renderLogin()">I am a voter</button>
    <button class="ivcf-button" onclick="renderLogin()">I am an admin</button>
    <p class="small"><a href="archive.html">üìÅ Vote archive</a></p>
  </div>`;
};

window.renderLogin = () => {
  app.innerHTML = `
  <div class="ivcf-card">
    <h1>Login</h1>
    <input class="ivcf-input" id="emailIn" placeholder="E-mail">
    <input class="ivcf-input" id="passIn" type="password" placeholder="Password">
    <button class="ivcf-button" onclick="logIn()">Login</button>
    <p class="small">No account? Ask the administrator.</p>
    <p class="small"><a href="#" onclick="renderGate();return false">‚Üê back</a></p>
  </div>`;
};

window.logIn = async () => {
  const em = $('#emailIn').value.trim();
  const pw = $('#passIn').value;
  try { await signInWithEmailAndPassword(auth, em, pw); }
  catch(e){ alert('Login failed: '+e.message); }
};

window.logOut = async () => { await signOut(auth); };

/* ==========================================
   ADMIN ONLY
   ========================================== */
window.renderAdminPanel = async () => {
  const pollSnap = await getDoc(doc(db,'polls','active'));
  const p = pollSnap.exists() ? pollSnap.data() : null;

  app.innerHTML = `
  <div class="ivcf-card" style="border-left:4px solid var(--green)">
    <h1>Admin Panel <span style="color:var(--green)">‚óè</span></h1>
    <input class="ivcf-input" id="titleIn" placeholder="Poll title" value="${p?p.title:''}">
    <input class="ivcf-input" id="endIn" type="datetime-local" value="${p?p.end:''}">
    <button class="ivcf-button" onclick="savePoll()">Create / Update poll</button>
    <hr style="border:none;border-top:1px solid #333;margin:1rem 0">
    <textarea class="ivcf-input" id="bulkIn" placeholder="Add voters:  email password (one per line)"></textarea>
    <button class="ivcf-button" onclick="addVoters()">Add voters</button>
    <button class="ivcf-button" onclick="dlCsv()">Download results CSV</button>
    <p class="small"><a href="#" onclick="logOut();return false">Logout</a></p>
  </div>`;
};

window.savePoll = async () => {
  const title = $('#titleIn').value.trim();
  const end   = $('#endIn').value;
  if(!title||!end){alert('Title and end date required');return;}
  await setDoc(doc(db,'polls','active'),{title,end,voters:[],votes:{},createdAt:new Date()});
  alert('Poll saved / updated');
};

window.addVoters = async () => {
  const lines = $('#bulkIn').value.split('\n').map(l=>l.trim()).filter(Boolean);
  let ok=0;
  for(const l of lines){
    const [email,pass] = l.split(/\s+/);
    if(!email||!pass) continue;
    try{
      await createUserWithEmailAndPassword(auth, email, pass);
      ok++;
    }catch(e){
      if(e.code==='auth/email-already-in-use') ok++;  // already exists ‚Äì count as ok
      else console.error(e);
    }
  }
  alert(`Processed ${ok} voter(s)`);
  $('#bulkIn').value='';
};

window.dlCsv = async () => {
  const snap = await getDoc(doc(db,'polls','active'));
  if(!snap.exists()){alert('No active poll');return;}
  const votes = snap.data().votes||{};
  const csv = `user,vote\n` +
        Object.entries(votes).map(([u,v])=>`${u},${v?'Yes':'No'}`).join('\n');
  const a = Object.assign(document.createElement('a'),{
    href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),
    download:`poll-${today()}.csv`
  }); a.click();
};

/* ==========================================
   VOTER FLOW
   ========================================== */
async function checkVoterAndLoad(email){
  const pollRef = doc(db,'polls','active');
  const pollSnap = await getDoc(pollRef);
  if(!pollSnap.exists()){ renderNoPoll(); return; }
  const p = pollSnap.data();
  if(new Date()>new Date(p.end)){ await archiveAndClose(p); return; }
  renderBallot(p, email);
  /* live updates */
  if(unsubPoll) unsubPoll();
  unsubPoll = onSnapshot(pollRef, snap=>{
    if(!snap.exists()) return;
    const fresh = snap.data();
    if(new Date()>new Date(fresh.end)){ archiveAndClose(fresh); return; }
    updateBar(fresh.votes||{});
  });
}

window.renderNoPoll = () => {
  app.innerHTML = `
  <div class="ivcf-card">
    <h1>No active polls</h1>
    <p>Please wait for the next poll to open.</p>
    <p class="small"><a href="archive.html">üìÅ Vote archive</a> ¬∑ <a href="#" onclick="logOut();return false">Logout</a></p>
  </div>`;
};

window.renderBallot = (poll, email) => {
  const already = poll.votes && Object.keys(poll.votes).includes(email);
  app.innerHTML = `
  <div class="ivcf-card">
    <h1>${poll.title}</h1>
    <p id="timer" class="small"></p>
    <div id="voted" style="display:none"><p>Your vote has been recorded ‚úÖ</p><p class="small">Live result:</p></div>
    <div id="ballot" style="display:${already?'none':'flex'};gap:.5rem">
      <button class="ivcf-button" onclick="vote(true)">Yes</button>
      <button class="ivcf-button" onclick="vote(false)">No</button>
    </div>
    <div id="barWrap"><div id="barYes"></div></div>
    <p class="small"><span id="yes">0</span> Yes (<span id="yesP">0</span>%) ¬∑ <span id="no">0</span> No (<span id="noP">0</span>%)</p>
    <p class="small"><a href="archive.html">üìÅ Vote archive</a> ¬∑ <a href="#" onclick="logOut();return false">Logout</a></p>
  </div>`;
  updateBar(poll.votes||{});
  countdown(poll.end);
  if(already){ ballot.style.display='none'; voted.style.display='block'; }
};

window.vote = async bool => {
  const pollRef = doc(db,'polls','active');
  const email = currentUser.email;
  await updateDoc(pollRef, { [`votes.${email}`]: bool });
  import('https://cdn.skypack.dev/canvas-confetti').then(({default:confetti})=>
    confetti({particleCount:120,spread:70,origin:{y:.7}})
  );
};

function updateBar(votes){
  const yes = Object.values(votes).filter(v=>v===true).length;
  const no  = Object.values(votes).filter(v=>v===false).length;
  const tot = yes+no||1;
  $('#yes').textContent  = yes;
  $('#no').textContent   = no;
  $('#yesP').textContent = (100*yes/tot).toFixed(1);
  $('#noP').textContent  = (100*no/tot).toFixed(1);
  $('#barYes').style.width = (100*yes/tot).toFixed(1)+'%';
}

function countdown(endIso){
  const end = new Date(endIso);
  const iv = setInterval(()=>{
    const sec = Math.max(0,Math.floor((end-new Date())/1000));
    if(!sec){ clearInterval(iv); archiveAndClose(); return; }
    $('#timer').textContent = `Closes in ${String(Math.floor(sec/3600)).padStart(2,0)}:${String(Math.floor(sec/60)%60).padStart(2,0)}:${String(sec%60).padStart(2,0)}`;
  },1000);
}

async function archiveAndClose(pollData){
  if(unsubPoll) { unsubPoll(); unsubPoll=null; }
  const p = pollData || (await getDoc(doc(db,'polls','active'))).data();
  /* move to archive */
  await setDoc(doc(db,'archive',Date.now().toString()), {
    ...p,
    archivedAt: new Date(),
    results: {
      yes: Object.values(p.votes||{}).filter(v=>v===true).length,
      no:  Object.values(p.votes||{}).filter(v=>v===false).length
    }
  });
  /* delete active */
  await deleteDoc(doc(db,'polls','active'));
  location.replace('archive.html');
}
</script>
</body>
</html>
