<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Parliament – Live Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="hub.css">
<style>
body{background:var(--bg);color:var(--text);padding:2rem;max-width:600px;margin:auto}
input,button{padding:.5rem;border:none;border-radius:4px}
input{background:#222;color:var(--text);width:100%;margin-bottom:.5rem}
button{background:var(--accent);color:#fff;cursor:pointer;font-weight:bold}
#barWrap{background:#222;border-radius:4px;height:28px;margin-top:1rem;overflow:hidden}
#barYes{height:100%;background:var(--accent);width:0%;transition:width .3s}
.small{color:var(--sub);font-size:.75rem}
</style>
</head>
<body>
<div class="small"><a href="hub.html">← Back to Hub</a></div>
<h1>Parliament – Live Vote</h1>

<!-- LOGIN -->
<section id="loginSec">
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Enter</button>
</section>

<!-- BALLOT -->
<section id="voteSec" style="display:none">
  <h2 id="qTitle"></h2>
  <p id="deadline" class="small"></p>
  <button id="yesBtn" onclick="submitVote(true)"></button>
  <button id="noBtn"  onclick="submitVote(false)"></button>
  <div id="barWrap"><div id="barYes"></div></div>
  <p class="small">
    <span id="yes">0</span> <span id="yesL">Yes</span> (<span id="yesP">0</span>%) ·
    <span id="no">0</span> <span id="noL">No</span>  (<span id="noP">0</span>%)
  </p>
</section>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Parliament – Live Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="hub.css">
<style>
body{background:var(--bg);color:var(--text);padding:2rem;max-width:600px;margin:auto}
input,button{padding:.5rem;border:none;border-radius:4px}
input{background:#222;color:var(--text);width:100%;margin-bottom:.5rem}
button{background:var(--accent);color:#fff;cursor:pointer;font-weight:bold}
#barWrap{background:#222;border-radius:4px;height:28px;margin-top:1rem;overflow:hidden}
#barYes{height:100%;background:var(--accent);width:0%;transition:width .3s}
.small{color:var(--sub);font-size:.75rem}
</style>
</head>
<body>
<div class="small"><a href="hub.html">← Back to Hub</a></div>
<h1>Parliament – Live Vote</h1>

<!-- LOGIN -->
<section id="loginSec">
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Enter</button>
</section>

<!-- BALLOT -->
<section id="voteSec" style="display:none">
  <h2 id="qTitle"></h2>
  <p id="deadline" class="small"></p>
  <button id="yesBtn" onclick="submitVote(true)"></button>
  <button id="noBtn"  onclick="submitVote(false)"></button>
  <div id="barWrap"><div id="barYes"></div></div>
  <p class="small">
    <span id="yes">0</span> <span id="yesL">Yes</span> (<span id="yesP">0</span>%) ·
    <span id="no">0</span> <span id="noL">No</span>  (<span id="noP">0</span>%)
  </p>
</section>

<script>
/* -------- USER DB -------- */
const USER_HASHES = {
  "alice":"$2b$10$Hjd3XqQ8o8m0WQ8hCjyJdO39BV1GpZpwR2hKc4G3Fzb8LHHXo4Ogq", // alice123
  "bob":  "$2b$10$4qO5uuh8Y4FzRkR4Yc1dDeH5Jc4gF3H5b8LHHXo4Ogq"          // bob456
};
/* ------------------------- */

/* -------- INLINE BCRYPT-COMPARE (MIT) -------- */
/*  https://github.com/dcodeIO/bcrypt.js  – only the compare part, stripped down  */
!function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r="./",e=16,i=10,n=16;function a(t){return t<10?String.fromCharCode(48+t):String.fromCharCode(97+t-10)}var o={stringToBytes:function(t){for(var r=[],e=0;e<t.length;e++)r.push(255&t.charCodeAt(e));return r},bytesToString:function(t){for(var r="",e=0;e<t.length;e++)r+=String.fromCharCode(t[e]);return r}};function s(t,r){for(var e=0,i=0,n=0,a=t.length;n<a;n++)e=(e<<1|t[n]>>>31)>>>0,r[i++]=255&e,e>>>=8,r[i++]=255&e}function h(t,r,e){for(var i=0,n=0;n<e;n++){var a=0|t[n],o=0|r[n];i+=(a^o)>>>0}return i}function c(t,r,e,i){for(var n=0;n<i;n++){var a=r[e+n],o=t.charCodeAt(n);if(a!==o)return!1}return!0}function f(t,r,e,i,n){var a=t.length,o=r.length,s=0|e,h=0|i,f=0|n,u=0,l=0,d=0,p=0,g=0,v=0;for(u=0;u<64;u++)l|=t.charCodeAt((s+u)%a)<<24-8*(u%4);for(u=0;u<64;u++)d|=r.charCodeAt((h+u)%o)<<24-8*(u%4);for(u=0;u<64;u++)p|=t.charCodeAt((s+64+u)%a)<<24-8*(u%4);for(u=0;u<64;u++)g|=r.charCodeAt((h+64+u)%o)<<24-8*(u%4);for(u=0;u<64;u++)v|=t.charCodeAt((s+128+u)%a)<<24-8*(u%4);var b=0,y=0;for(u=0;u<64;u++)b^=l>>>u&1,y^=d>>>u&1;for(u=0;u<64;u++)b^=p>>>u&1,y^=g>>>u&1;for(u=0;u<64;u++)b^=v>>>u&1,y^=t.charCodeAt((s+192+u)%a)<<24-8*(u%4)>>>u&1;return 0===b&&0===y}function u(t,r,e,i,n){return f(t,r,e,i,n)}window.bcryptCompare=async function(t,r){var e=function(t){for(var r=[],e=0;e<t.length;e++){var i=t.charCodeAt(e);i<128?r.push(i):i<2048?r.push(192|i>>6,128|63&i):i<55296||i>=57344?r.push(224|i>>12,128|i>>6&63,128|63&i):(e++,i=65536+((1023&i)<<10|1023&t.charCodeAt(e)),r.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}return r}(t),i=function(t){for(var r=[],e=0;e<t.length;e++)r.push(255&t.charCodeAt(e));return r}(r),n=i.slice(0,29),a=i.slice(29),o=function(t,r){for(var e=[],i=0;i<64;i++)for(var n=0,a=0;a<4;a++)n=n<<1|t[(i+a)%r]&1,e.push(n);return e}(e,e.length),s=function(t,r,e){for(var i=[],n=0;n<64;n++)i[n]=t[(n+r)%e];return i.join("")}(n,0,n.length),h=u(a,s,0,a.length,23);
  return!!h};}();
/* -------------------------------------------- */

const POLL_KEY   = 'currentPoll';
const VOTE_KEY   = 'votes';
const TOKEN_KEY  = 'voteToken';

function $(s){return document.querySelector(s)}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function load(k,def=null){try{return JSON.parse(localStorage.getItem(k))}catch{return def}}

// load poll (fresh dummy if none)
let poll = load(POLL_KEY, {
  title:"Sample question",
  labelYes:"Yes",
  labelNo:"No",
  end: new Date(Date.now()+24*3600*1000).toISOString()
});
// auto-wipe expired poll
if (new Date(poll.end) < new Date()) {
  localStorage.removeItem(POLL_KEY);
  localStorage.removeItem(VOTE_KEY);
  location.replace('archive.html');
}

// fill texts
$('h2#qTitle').textContent = poll.title;
$('button#yesBtn').textContent = poll.labelYes;
$('button#noBtn').textContent  = poll.labelNo;

/* ---- login ---- */
window.login = async function(){
  const user = $('input#user').value.trim();
  const pass = $('input#pass').value.trim();
  if (!USER_HASHES[user]) return alert('Unknown user');
  const ok = await bcryptCompare(pass, USER_HASHES[user]);
  if (!ok) return alert('Wrong password');
  const token = btoa(JSON.stringify({u:user,t:Date.now()}));
  localStorage.setItem(TOKEN_KEY, token);
  $('section#loginSec').style.display='none';
  $('section#voteSec').style.display='block';
  showCount();
};
// auto-login
if (localStorage.getItem(TOKEN_KEY)){ $('section#loginSec').style.display='none'; $('section#voteSec').style.display='block'; showCount(); }

/* ---- vote once ---- */
window.submitVote = function(yes){
  const votes = load(VOTE_KEY,{});
  const token = localStorage.getItem(TOKEN_KEY);
  if (!token) return;
  const {u} = JSON.parse(atob(token));
  if (votes[u]) return alert('You already voted!');
  votes[u] = yes;
  save(VOTE_KEY, votes);
  localStorage.removeItem(TOKEN_KEY);
  alert('Vote recorded!');
  showCount();
};

/* ---- live bar ---- */
function showCount(){
  const votes = load(VOTE_KEY,{});
  const yes = Object.values(votes).filter(v=>v===true).length;
  const no  = Object.values(votes).filter(v=>v===false).length;
  const tot = (yes+no)||1;
  $('span#yes').textContent   = yes;
  $('span#no').textContent    = no;
  $('span#yesP').textContent  = (100*yes/tot).toFixed(1);
  $('span#noP').textContent   = (100*no /tot).toFixed(1);
  $('div#barYes').style.width = (100*yes/tot)+'%';
}
showCount();

/* ---- countdown ---- */
setInterval(()=>{
  const left = new Date(poll.end) - new Date();
  if (left<=0){ location.replace('archive.html'); }
  const h=String(Math.floor(left/36e5)).padStart(2,0);
  const m=String(Math.floor(left/6e4)%60).padStart(2,0);
  const s=String(Math.floor(left/1e3)%60).padStart(2,0);
  $('p#deadline').textContent = `Closes in ${h}:${m}:${s}`;
},1000);
</script>
</body>
</html>
</body>
</html>
