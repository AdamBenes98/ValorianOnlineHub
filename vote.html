<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Parliament – Live Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="hub.css">
<style>
body{background:var(--bg);color:var(--text);padding:2rem;max-width:600px;margin:auto}
input,button{padding:.5rem;border:none;border-radius:4px}
input{background:#222;color:var(--text);width:100%;margin-bottom:.5rem}
button{background:var(--accent);color:#fff;cursor:pointer;font-weight:bold}
#barWrap{background:#222;border-radius:4px;height:28px;margin-top:1rem;overflow:hidden}
#barYes{height:100%;background:var(--accent);width:0%;transition:width .3s}
.small{color:var(--sub);font-size:.75rem}
</style>
</head>
<body>
<div class="small"><a href="hub.html">← Back to Hub</a></div>
<h1>Parliament – Live Vote</h1>

<!-- LOGIN -->
<section id="loginSec">
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Enter</button>
</section>

<!-- BALLOT -->
<section id="voteSec" style="display:none">
  <h2 id="qTitle"></h2>
  <p id="deadline" class="small"></p>
  <button id="yesBtn" onclick="submitVote(true)"></button>
  <button id="noBtn"  onclick="submitVote(false)"></button>
  <div id="barWrap"><div id="barYes"></div></div>
  <p class="small">
    <span id="yes">0</span> <span id="yesL">Yes</span> (<span id="yesP">0</span>%) ·
    <span id="no">0</span> <span id="noL">No</span>  (<span id="noP">0</span>%)
  </p>
</section>

<script type="module">
/* -------- user DB -------- */
const USER_HASHES = {
  "alice":"$2b$10$Hjd3XqQ8o8m0WQ8hCjyJdO39BV1GpZpwR2hKc4G3Fzb8LHHXo4Ogq", // alice123
  "bob":  "$2b$10$4qO5uuh8Y4FzRkR4Yc1dDeH5Jc4gF3H5b8LHHXo4Ogq"          // bob456
};
/* ------------------------- */
const POLL_KEY   = 'currentPoll';
const VOTE_KEY   = 'votes';
const TOKEN_KEY  = 'voteToken';

function $(s){return document.querySelector(s)}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function load(k,def=null){try{return JSON.parse(localStorage.getItem(k))}catch{return def}}

// load poll (fallback dummy if nothing exists)
let poll = load(POLL_KEY, {
  title:"Sample question",
  labelYes:"Yes",
  labelNo:"No",
  end: new Date(Date.now()+24*3600*1000).toISOString()   // +24 h
});

// if stored poll is expired, wipe it and use fresh one
if (new Date(poll.end) < new Date()) {
  localStorage.removeItem(POLL_KEY);
  poll = load(POLL_KEY, poll);          // now uses the fresh one from code
  localStorage.removeItem(VOTE_KEY);    // also reset votes
}

// redirect to archive if still expired (should never happen now)
if (new Date(poll.end) < new Date()) location.replace('archive.html');

// fill texts
$('h2#qTitle').textContent = poll.title;
$('button#yesBtn').textContent = poll.labelYes;
$('button#noBtn').textContent  = poll.labelNo;

/* ---- login ---- */
window.login = async function(){
  const user = $('input#user').value.trim();
  const pass = $('input#pass').value.trim();
  if (!USER_HASHES[user]) return alert('Unknown user');
  const bc = await import('https://cdn.skypack.dev/bcryptjs');
  const ok = await bc.compare(pass, USER_HASHES[user]);
  if (!ok) return alert('Wrong password');
  const token = btoa(JSON.stringify({u:user,t:Date.now()}));
  localStorage.setItem(TOKEN_KEY, token);
  $('section#loginSec').style.display='none';
  $('section#voteSec').style.display='block';
  showCount();
};
// auto-login if token present
if (localStorage.getItem(TOKEN_KEY)){ $('section#loginSec').style.display='none'; $('section#voteSec').style.display='block'; showCount(); }

/* ---- vote once ---- */
window.submitVote = function(yes){
  const votes = load(VOTE_KEY,{});
  const token = localStorage.getItem(TOKEN_KEY);
  if (!token) return;
  const {u} = JSON.parse(atob(token));
  if (votes[u]) return alert('You already voted!');
  votes[u] = yes;
  save(VOTE_KEY, votes);
  localStorage.removeItem(TOKEN_KEY);   // burn token
  alert('Vote recorded!');
  showCount();
};

/* ---- live bar ---- */
function showCount(){
  const votes = load(VOTE_KEY,{});
  const yes = Object.values(votes).filter(v=>v===true).length;
  const no  = Object.values(votes).filter(v=>v===false).length;
  const tot = (yes+no)||1;
  $('span#yes').textContent   = yes;
  $('span#no').textContent    = no;
  $('span#yesP').textContent  = (100*yes/tot).toFixed(1);
  $('span#noP').textContent   = (100*no /tot).toFixed(1);
  $('div#barYes').style.width = (100*yes/tot)+'%';
}
showCount();

/* ---- countdown ---- */
setInterval(()=>{
  const left = new Date(poll.end) - new Date();
  if (left<=0){ location.replace('archive.html'); }
  const h=String(Math.floor(left/36e5)).padStart(2,0);
  const m=String(Math.floor(left/6e4)%60).padStart(2,0);
  const s=String(Math.floor(left/1e3)%60).padStart(2,0);
  $('p#deadline').textContent = `Closes in ${h}:${m}:${s}`;
},1000);
</script>
</body>
</html>
